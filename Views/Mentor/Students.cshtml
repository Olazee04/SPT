@model List<SPT.Models.ViewModels.StudentPerformanceViewModel>
@{
    ViewData["Title"] = "My Students";
}


<div class="row mb-4 g-3">

    <div class="col-md-4">
        <div class="custom-card text-center p-4">
            <h6 class="text-muted text-uppercase small">My Students</h6>
            <h2 class="fw-bold">@ViewBag.MyStudentsCount</h2>
        </div>
    </div>

    <div class="col-md-4">
        <div class="custom-card text-center p-4">
            <h6 class="text-muted text-uppercase small">Pending Logs</h6>
            <h2 class="fw-bold text-warning">@ViewBag.PendingLogs</h2>
        </div>
    </div>

    <div class="col-md-4">
        <div class="custom-card text-center p-4">
            <h6 class="text-muted text-uppercase small">Avg Consistency</h6>
            <h2 class="fw-bold text-success">@ViewBag.AvgConsistency%</h2>
        </div>
    </div>

</div>


<div class="custom-card p-0 overflow-hidden">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light text-muted small text-uppercase">
                <tr>
                    <th class="ps-4">Student</th>
                    <th>Cohort</th>
                    <th>Track</th>
                    <th class="text-center">Hrs (7d)</th>
                    <th>Progress</th>
                    <th>Status</th>
                    <th>Consistency</th>
                </tr>
            </thead>
            <tbody>

                @foreach (var s in Model)
                {
                    <tr>
                        <td class="ps-4">
                            <div class="d-flex align-items-center">
                                <img src="@(s.ProfilePicture ?? "/images/default-avatar.png")"
                                     class="rounded-circle me-3 border"
                                     style="width:38px;height:38px;object-fit:cover;">

                                <div>
                                    <span class="fw-bold d-block">@s.FullName</span>
                                    <small class="text-muted">@s.Email</small>
                                </div>
                            </div>
                        </td>

                        <td>@s.CohortName</td>

                        <td>
                            <span class="badge bg-light border text-dark">
                                @s.TrackCode
                            </span>
                        </td>

                        <td class="text-center">
                            <strong>@s.HoursLast7Days</strong>
                            <div class="small text-muted">
                                @s.CheckInsLast7Days check-ins
                            </div>
                        </td>

                        <td style="width:160px;">
                            @{
                                double modProgress =
                                s.TotalModules == 0 ? 0 :
                                ((double)s.CompletedModules / s.TotalModules) * 100;
                            }

                            <div class="small mb-1">
                                @s.CompletedModules / @s.TotalModules
                            </div>

                            <div class="progress" style="height:6px;">
                                <div class="progress-bar bg-primary"
                                     style="width:@modProgress%"></div>
                            </div>
                        </td>

                        <td>
                            @if (s.Status == "Active")
                            {
                                <span class="badge bg-success">Active</span>
                            }
                            else if (s.Status == "At Risk")
                            {
                                <span class="badge bg-danger">At Risk</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Inactive</span>
                            }
                        </td>

                        <td style="width:130px;">
                            @{
                                string barColor =
                                s.ConsistencyScore >= 75 ? "bg-success" :
                                s.ConsistencyScore >= 40 ? "bg-warning" :
                                "bg-danger";
                            }

                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1 me-2" style="height:6px;">
                                    <div class="progress-bar @barColor"
                                         style="width:@s.ConsistencyScore%"></div>
                                </div>
                                <small class="fw-bold">
                                    @s.ConsistencyScore%
                                </small>
                            </div>
                        </td>
                    </tr>
                }

            </tbody>
        </table>
    </div>
</div>


<div class="custom-card mt-4">
    <h5 class="card-title-custom mb-3">
        📝 Logs Needing Review
    </h5>

    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="bg-light small text-uppercase">
                <tr>
                    <th>Student</th>
                    <th>Module</th>
                    <th>Date</th>
                    <th>Hours</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>

                @if (ViewBag.PendingLogsList != null && ViewBag.PendingLogsList.Count > 0)
                {
                    foreach (var log in ViewBag.PendingLogsList)
                    {
                        <tr>
                            <td>@log.Student.FullName</td>
                            <td>@log.Module.ModuleCode</td>
                            <td>@log.Date.ToShortDateString()</td>
                            <td>@log.Hours</td>
                            <td>
                                <form asp-action="ApproveLog" method="post">
                                    <input type="hidden" name="id" value="@log.Id" />
                                    <button class="btn btn-success btn-sm">
                                        Approve
                                    </button>
                                </form>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="5" class="text-center text-muted py-4">
                            No logs needing review
                        </td>
                    </tr>
                }

            </tbody>
        </table>
    </div>
</div>
