@model SPT.Models.ProgressLog

@{
    ViewData["Title"] = "Log Daily Progress";
    bool canLogProject = ViewBag.UnlockProject ?? false;
    double currentProgress = ViewBag.CurrentProgress ?? 0;
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white py-3">
                    <h4 class="mb-0"><i class="fas fa-edit"></i> Log Daily Progress</h4>
                    <small>Transparency is key, @ViewBag.StudentName!</small>
                </div>
                <div class="card-body p-4">

                    <form asp-action="Create" method="post">
                        @Html.AntiForgeryToken()

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Date" class="form-label fw-bold">Date *</label>
                                <input asp-for="Date" type="date" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                                <span asp-validation-for="Date" class="text-danger"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="Location" class="form-label fw-bold">Where did you work today? *</label>
                                <select asp-for="Location" class="form-select">
                                    <option value="Remote">🏠 Remote / Home</option>
                                    <option value="Office">🏢 Office / On-Site</option>
                                </select>
                                <span asp-validation-for="Location" class="text-danger"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="Hours" class="form-label fw-bold">Hours Spent *</label>
                                <input asp-for="Hours" type="number" step="0.5" class="form-control" placeholder="e.g. 4.5" min="0.5" max="24" />
                                <span asp-validation-for="Hours" class="text-danger"></span>
                            </div>

                            <div class="col-md-12 mb-3">
                                <label asp-for="ModuleId" class="form-label fw-bold">Module / Topic *</label>
                                <select asp-for="ModuleId" class="form-select" asp-items="ViewBag.ModuleId">
                                    <option value="">-- Select What You Learned --</option>
                                    <option value="999">Other / Research</option>
                                </select>
                                <span asp-validation-for="ModuleId" class="text-danger"></span>
                            </div>

                            <div class="col-md-12 mb-3">
                                <label asp-for="LessonCovered" class="form-label fw-bold">Specific Lesson / Activity *</label>
                                <input asp-for="LessonCovered" class="form-control" placeholder="e.g. Learned about Async/Await" />
                                <span asp-validation-for="LessonCovered" class="text-danger"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <div class="form-check p-3 border rounded bg-light h-100 d-flex align-items-center">
                                    <input asp-for="PracticeDone" class="form-check-input me-2" type="checkbox" />
                                    <label asp-for="PracticeDone" class="form-check-label fw-bold">I did practical coding</label>
                                </div>
                            </div>

                            <div class="col-md-12 mb-3">
                                <label asp-for="EvidenceLink" id="evidenceLabel" class="form-label fw-bold">Evidence Link (GitHub / Slack)</label>

                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-link"></i></span>
                                    <input asp-for="EvidenceLink" id="evidenceInput" type="url" class="form-control" placeholder="https://github.com/..." />
                                </div>
                                <span asp-validation-for="EvidenceLink" class="text-danger"></span>

                                <small id="evidenceHelp" class="text-muted">Optional for study-only days.</small>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="Blocker" class="form-label">Any Blockers? (Optional)</label>
                                <textarea asp-for="Blocker" class="form-control" rows="2" placeholder="What got you stuck?"></textarea>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="NextGoal" class="form-label">Goal for Tomorrow (Optional)</label>
                                <textarea asp-for="NextGoal" class="form-control" rows="2" placeholder="What will you learn next?"></textarea>
                            </div>

                            <div class="col-12 text-end mt-3">
                                <a asp-controller="Student" asp-action="Dashboard" class="btn btn-secondary me-2">Cancel</a>
                                <button type="submit" class="btn btn-success btn-lg px-5">Submit Log</button>
                            </div>
                        </div>
                    </form>

                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // 1. Get the list of IDs that REQUIRE an assignment from C#
        var assignmentModules = @Html.Raw(Json.Serialize(ViewBag.AssignmentModules));

        // 2. Get DOM Elements
        var moduleSelect = document.getElementById("ModuleId"); // Ensure your select has asp-for="ModuleId"
        var evidenceInput = document.getElementById("evidenceInput");
        var evidenceLabel = document.getElementById("evidenceLabel");
        var evidenceHelp = document.getElementById("evidenceHelp");

        function checkAssignment() {
            // Get selected ID (convert to integer)
            var selectedId = parseInt(moduleSelect.value);

            // Check if this ID exists in our "Assignment Required" list
            if (assignmentModules.includes(selectedId)) {
                // ENFORCE REQUIREMENT
                evidenceInput.setAttribute("required", "required");
                evidenceLabel.innerHTML = "Evidence Link (GitHub) <span class='text-danger'>* Required for this Task</span>";
                evidenceHelp.className = "text-danger fw-bold";
                evidenceHelp.innerText = "⚠️ This module has a mandatory assignment. You must provide a link.";
            } else {
                // MAKE OPTIONAL
                evidenceInput.removeAttribute("required");
                evidenceLabel.innerHTML = "Evidence Link (GitHub / Slack)";
                evidenceHelp.className = "text-muted";
                evidenceHelp.innerText = "Optional for study-only days.";
            }
        }

        // Run on change and on page load (in case of validation error reload)
        moduleSelect.addEventListener("change", checkAssignment);
        checkAssignment(); // Run once immediately
    </script>
}