@model SPT.Models.ProgressLog

@{
    ViewData["Title"] = "Log Daily Progress";
    bool canLogProject = ViewBag.UnlockProject ?? false;
    double currentProgress = ViewBag.CurrentProgress ?? 0;
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg border-0 leaderboard-card">
                <div class="card-header bg-primary text-white py-3">
                    <h4 class="mb-0"><i class="fas fa-edit"></i> Log Daily Progress</h4>
                    <small>Transparency is key, @ViewBag.StudentName!</small>
                </div>
                <div class="card-body p-4">

                    <form asp-action="Create" method="post">
                        @Html.AntiForgeryToken()

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Date" class="form-label fw-bold">Date *</label>
                                <input asp-for="Date" type="date" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                                <span asp-validation-for="Date" class="text-danger"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="Location" class="form-label fw-bold">Where did you work today? *</label>
                                <select asp-for="Location" class="form-select">
                                    <option value="Remote">🏠 Remote / Home</option>
                                    <option value="Office">🏢 Office / On-Site</option>
                                </select>
                                <span asp-validation-for="Location" class="text-danger"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="Hours" class="form-label fw-bold">Hours Spent *</label>
                                <input asp-for="Hours" type="number" step="0.5" class="form-control" placeholder="e.g. 4.5" min="0.5" max="24" />
                                <span asp-validation-for="Hours" class="text-danger"></span>
                            </div>

                            <div class="col-md-12 mb-3">
                                <label asp-for="ModuleId" class="form-label fw-bold">Module / Topic *</label>
                                <select asp-for="ModuleId" class="form-select" asp-items="ViewBag.ModuleId">
                                    <option value="">-- Select What You Learned --</option>
                                    <option value="999">Other / Research</option>
                                </select>
                                <span asp-validation-for="ModuleId" class="text-danger"></span>
                            </div>

                            <div class="col-md-12 mb-3">
                                <label asp-for="LessonCovered" class="form-label fw-bold">Specific Lesson / Activity *</label>
                                <input asp-for="LessonCovered" class="form-control" placeholder="e.g. Learned about Async/Await" />
                                <span asp-validation-for="LessonCovered" class="text-danger"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <div class="form-check p-3 border rounded bg-light h-100 d-flex align-items-center">
                                    <input asp-for="PracticeDone" class="form-check-input me-2" type="checkbox" />
                                    <label asp-for="PracticeDone" class="form-check-label fw-bold">I did practical coding</label>
                                </div>
                            </div>

                            <div id="miniProjectSection" style="display:none;" class="card bg-light border-primary mb-3">
                                <div class="card-body">
                                    <label asp-for="MiniProjectProgress" class="form-label fw-bold text-primary">
                                        <i class="fas fa-rocket"></i> Project Completion (%)
                                    </label>
                                    <input asp-for="MiniProjectProgress" type="range" class="form-range" min="0" max="100" step="5" id="projectRange" oninput="document.getElementById('rangeVal').innerText = this.value + '%'">
                                    <div class="text-center fw-bold" id="rangeVal">0%</div>
                                    <small class="text-muted">Rate how far you have gone with your Capstone Project.</small>
                                </div>
                            </div>

                            <div class="col-md-12 mb-3">
                                <label asp-for="EvidenceLink" id="evidenceLabel" class="form-label fw-bold">Evidence Link (GitHub / Slack)</label>

                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-link"></i></span>
                                    <input asp-for="EvidenceLink" id="evidenceInput" type="url" class="form-control" placeholder="https://github.com/..." />
                                </div>
                                <span asp-validation-for="EvidenceLink" class="text-danger"></span>

                                <small id="evidenceHelp" class="text-muted">Optional for study-only days.</small>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="Blocker" class="form-label">Any Blockers? (Optional)</label>
                                <textarea asp-for="Blocker" class="form-control" rows="2" placeholder="What got you stuck?"></textarea>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="NextGoal" class="form-label">Goal for Tomorrow (Optional)</label>
                                <textarea asp-for="NextGoal" class="form-control" rows="2" placeholder="What will you learn next?"></textarea>
                            </div>

                            <div class="col-12 text-end mt-3">
                                <a asp-controller="Student" asp-action="Dashboard" class="btn btn-secondary me-2">Cancel</a>
                                <button type="submit" class="btn btn-success btn-lg px-5">Submit Log</button>
                            </div>
                        </div>
                    </form>

                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        var assignmentModules = @Html.Raw(Json.Serialize(ViewBag.AssignmentModules));
        var miniProjectModules = @Html.Raw(Json.Serialize(ViewBag.MiniProjectModules)); // Get IDs

        var moduleSelect = document.getElementById("ModuleId");
        var evidenceInput = document.getElementById("evidenceInput");
        var evidenceLabel = document.getElementById("evidenceLabel");
        var projectSection = document.getElementById("miniProjectSection"); // The Slider Div

        function checkRequirements() {
            var selectedId = parseInt(moduleSelect.value);

            // 1. Check Assignment (Existing Logic)
            if (assignmentModules.includes(selectedId)) {
                evidenceInput.setAttribute("required", "required");
                evidenceLabel.innerHTML = "Evidence Link <span class='text-danger'>* Required</span>";
            } else {
                evidenceInput.removeAttribute("required");
                evidenceLabel.innerHTML = "Evidence Link (Optional)";
            }

            // 2. Check Mini Project (New Logic)
            if (miniProjectModules.includes(selectedId)) {
                projectSection.style.display = "block"; // SHOW SLIDER
            } else {
                projectSection.style.display = "none";  // HIDE SLIDER
            }
        }

        moduleSelect.addEventListener("change", checkRequirements);
        checkRequirements(); // Run on load
    </script>
}