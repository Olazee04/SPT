@model List<SPT.Models.ProgressLog>
@{
    ViewData["Title"] = "Master Progress Logs";
    string status = ViewBag.CurrentStatus as string;
}

<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="font-weight-bold text-gray-800"><i class="fas fa-clipboard-check text-primary mr-2"></i> Review Activity Logs</h2>

            @if (ViewBag.IsFiltered == true)
            {
                <div class="badge badge-warning text-dark p-2 mt-1">
                    <i class="fas fa-filter mr-1"></i> Filtering for: <strong>@ViewBag.FilterName</strong>
                </div>
            }
            else
            {
                <p class="text-muted mb-0">Approve, reject, or edit student submissions.</p>
            }
        </div>

        @if (ViewBag.IsFiltered == true)
        {
            <a asp-action="ProgressLogs" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-times mr-1"></i> Clear Filter
            </a>
        }
    </div>

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 bg-white p-3 rounded shadow-sm border-left-primary">
        <div class="mb-2 mb-md-0">
            <h5 class="font-weight-bold mb-0 text-gray-800">Activity Logs</h5>
            <p class="text-muted small mb-0">Audit daily submissions.</p>
        </div>

        <div class="d-flex align-items-center">
            <div class="btn-group shadow-sm mr-3">
                <a asp-action="ProgressLogs" asp-route-status="All"
                   class="btn btn-sm @(status == "All" || status == null ? "btn-primary" : "btn-light border")">All</a>
                <a asp-action="ProgressLogs" asp-route-status="Pending"
                   class="btn btn-sm @(status == "Pending" ? "btn-warning text-dark font-weight-bold" : "btn-light border")">Pending</a>
                <a asp-action="ProgressLogs" asp-route-status="Approved"
                   class="btn btn-sm @(status == "Approved" ? "btn-success font-weight-bold" : "btn-light border")">Approved</a>
            </div>

            <form method="get" class="form-inline">
                <input type="hidden" name="status" value="@status" />
                <div class="input-group">
                    <input type="text" name="search" class="form-control bg-light border-0 small"
                           placeholder="Search..." value="@ViewBag.CurrentSearch">
                    <div class="input-group-append">
                        <button class="btn btn-dark" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm border-0 leaderboard-card">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light text-muted small text-uppercase">
                    <tr>
                        <th class="pl-4">Student</th>
                        <th>Date</th>
                        <th>Module / Description</th>
                        <th>Blocker</th>
                        <th class="text-center">Hours</th>
                        <th class="text-center">Evidence</th>
                        <th class="text-center">Status</th>
                        <th class="text-right pr-4">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Any())
                    {
                        foreach (var log in Model)
                        {
                            <tr>
                                <td class="pl-4">
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-light text-primary mr-2 font-weight-bold border d-flex align-items-center justify-content-center"
                                             style="width:35px;height:35px;">
                                            @(log.Student?.FullName.Substring(0, 1) ?? "?")
                                        </div>
                                        <div>
                                            <span class="d-block font-weight-bold text-dark small">@log.Student?.FullName</span>
                                            <span class="badge badge-light border text-muted leaderboard-card" style="font-size:0.65rem;">@log.Student?.Track?.Code</span>
                                        </div>
                                    </div>
                                </td>

                                <td class="small text-muted">
                                    <i class="far fa-calendar-alt mr-1"></i> @log.Date.ToString("MMM dd")
                                </td>

                                <td>
                                    <div class="text-truncate" style="max-width: 180px;" title="@log.ActivityDescription">
                                        @(string.IsNullOrEmpty(log.ActivityDescription) ? "No description" : log.ActivityDescription)
                                    </div>
                                    @if (log.Module != null)
                                    {
                                        <small class="text-primary font-weight-bold">@log.Module.ModuleCode</small>
                                    }
                                </td>

                                <td class="small text-muted">
                                    @(string.IsNullOrEmpty(log.Blocker) ? "-" : log.Blocker)
                                </td>

                                <td class="text-center font-weight-bold">@log.Hours</td>

                                <td class="text-center">
                                    @if (!string.IsNullOrEmpty(log.EvidenceUrl))
                                    {
                                        <a href="@log.EvidenceUrl" target="_blank" class="btn btn-sm btn-light border text-primary" title="Open Link">
                                            <i class="fas fa-external-link-alt"></i>
                                        </a>
                                    }
                                    else
                                    {
                                        <span class="text-muted small">-</span>
                                    }
                                </td>

                                <td class="text-center leaderboard-card">
                                    @if (log.IsApproved)
                                    {
                    <span class="badge rounded-pill bg-success px-3 py-2">
                        <i class="fas fa-check-circle me-1"></i> Approved
                    </span>
                                    }
                                    else
                                    {
                    <span class="badge rounded-pill bg-warning text-dark px-3 py-2">
                        <i class="fas fa-hourglass-half me-1"></i> Pending
                    </span>
                                    }
        </td>


                                <td class="text-right pr-4">
                                    <button type="button" class="btn btn-sm btn-outline-primary"
                                                    data-bs-toggle="modal" data-bs-target="#logModal_@log.Id">
                                        <i class="fas fa-eye mr-1"></i> Review
                                    </button>
                                </td>
                            </tr>

                            <div class="modal fade" id="logModal_@log.Id" tabindex="-1" role="dialog" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered" role="document">
                                    <div class="modal-content border-0 leaderboard-card shadow-lg">
                                        <div class="modal-header bg-primary text-white">
                                            <h5 class="modal-title font-weight-bold">Review Log</h5>
                                            <button type="button" class="close text-white" data-bs-dismiss="modal"
                                                    aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body p-4 leaderboard-card">
                                            <div class="d-flex align-items-center mb-3 p-3 bg-light rounded border">
                                                <div>
                                                    <h6 class="mb-0 font-weight-bold text-gray-800">@log.Student?.FullName</h6>
                                                    <small class="text-muted">@log.Date.ToString("D")</small>
                                                </div>

                                                <div class="ml-auto text-right">
                                                    <h4 class="font-weight-bold text-primary mb-0">@log.Hours</h4>
                                                    <small class="text-muted">Hours</small>
                                                </div>
                                            </div>

                                            <div class="mb-3 leaderboard-card">
                                                <label class="small text-muted font-weight-bold text-uppercase">Description</label>
                                                <p class="p-3 border rounded bg-white small mb-0">
                                                    @(string.IsNullOrEmpty(log.ActivityDescription) ? "No description." : log.ActivityDescription)
                                                </p>
                                            </div>

                                            <div class="mb-3">
                                                <label class="small fw-bold text-muted">Student Blocker</label>
                                                <div class="border rounded p-2 bg-light small">
                                                    @(log.Blocker ?? "—")
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <label class="small fw-bold text-muted">Next Goal</label>
                                                <div class="border rounded p-2 bg-light small">
                                                    @(log.NextGoal ?? "—")
                                                </div>
                                            </div>


                                            @if (!string.IsNullOrEmpty(log.EvidenceUrl))
                                            {
                                                <div class="mb-3">
                                                    <a href="@log.EvidenceUrl" target="_blank" class="btn btn-outline-primary btn-sm btn-block">
                                                        <i class="fas fa-external-link-alt mr-1"></i> Open Evidence Link
                                                    </a>
                                                </div>
                                            }

                                                   <form asp-action="UpdateLog" method="post">
            <input type="hidden" name="id" value="@log.Id" />
                                                <div class="mb-2">
                                                    <label class="small fw-bold">Adjust Hours</label>
                                                    <input type="number"
                                                           name="hours"
                                                           value="@log.Hours"
                                                           step="0.5"
                                                           min="0.5"
                                                           max="5"
                                                           class="form-control form-control-sm" />
                                                </div>


            <div class="row g-2">
                <div class="col">
                    <label class="form-label small fw-bold">Rating</label>
                    <select name="mentorRating" class="form-select form-select-sm">
                        <option value="">--</option>
                        <option value="5">⭐ 5</option>
                        <option value="4">⭐ 4</option>
                        <option value="3">⭐ 3</option>
                        <option value="2">⭐ 2</option>
                        <option value="1">⭐ 1</option>
                    </select>
                </div>

                <div class="col">
                    <label class="form-label small fw-bold">Quiz Score</label>
                                                        <input type="number"
                                                                name="quizScore"
                                                                class="form-control form-control-sm"
                                                                min="0"
                                                                max="100"
                                                        @(log.PracticeDone ? "" : "disabled") />

                </div>
            </div>

                                                <div class="mt-3">
                                                    <label class="small fw-bold">Mentor Advice</label>
                                                    <textarea name="mentorResponse"
                                                              class="form-control form-control-sm"
                                                              rows="2"
                                                              placeholder="Reply to blocker or give guidance...">@log.MentorResponse</textarea>
                                                </div>


            <div class="d-flex justify-content-end mt-3">
                <button type="submit"
                        name="action"
                        value="Reject"
                        class="btn btn-outline-danger btn-sm me-2"
                        onclick="return confirm('Reject this log?');">
                    <i class="fas fa-times"></i> Reject
                </button>

                <button type="submit"
                        name="action"
                        value="Approve"
                        class="btn btn-success btn-sm px-4">
                    <i class="fas fa-check"></i> Approve
                </button>
            </div>
        </form>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="7" class="text-center py-5">
                                <i class="fas fa-folder-open fa-3x text-muted opacity-25 mb-3"></i>
                                <h6 class="text-muted">No logs found</h6>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>



