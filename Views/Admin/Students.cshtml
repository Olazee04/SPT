@model List<SPT.Models.ViewModels.StudentPerformanceViewModel>
@{
    ViewData["Title"] = "Student Management";
}

<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Total Students
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            @ViewBag.TotalStudents
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-users fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold"><i class="fas fa-user-graduate me-2"></i> Students Directory</h4>

    <div class="d-flex gap-2">
        <form method="get" class="d-flex">
            <input type="text" name="searchString" class="form-control me-2" placeholder="Search students..." style="width: 250px;">
            <button type="submit" class="btn btn-primary">Search</button>
        </form>
        <a asp-action="ImportStudents" class="btn btn-success btn-sm mr-1">
            <i class="fas fa-file-csv fa-sm"></i> Bulk Import
        </a>
        <a asp-controller="Admin" asp-action="ExportStudents" class="btn btn-outline-success btn-sm">
            <i class="fas fa-file-csv me-1"></i> Export CSV
        </a>
        <a asp-action="CreateStudent" class="btn btn-success"><i class="fas fa-plus"></i> New Student</a>
    </div>
</div>

<div class="custom-card p-0 overflow-hidden">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light text-muted small text-uppercase">
                <tr>
                    <th class="ps-4">Student Name</th>
                    <th>Cohort</th>
                    <th>Track</th>
                    <th>Mentor</th>
                    <th class="text-center">Hrs (7d)</th>
                    <th>Progress</th>
                    <th>Status</th>
                    <th>Consistency</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var s in Model)

                {
                    <tr>
                        <td class="ps-4">
                            <a asp-action="Details" asp-route-id="@s.StudentId" class="text-decoration-none fw-bold">
                                <div class="d-flex align-items-center">
                                    <img src="@(s.ProfilePicture ?? "/images/default-avatar.png")" class="rounded-circle me-3 border" style="width:35px;height:35px;object-fit:cover;">
                                    <div>
                                        <span class="d-block fw-bold">@s.FullName</span>
                                        <small class="text-muted">@s.Email</small>
                                    </div>
                                </div>
                            </a>
                        </td>
                        <td>@s.CohortName</td>
                        <td><span class="badge bg-light fw-bold border">@s.TrackCode</span></td>
                        <td>@s.MentorName</td>

                        <td class="text-center">
                            <strong>@s.HoursLast7Days</strong>
                            <div class="small text-muted">@s.CheckInsLast7Days check-ins</div>
                        </td>

                        <td style="width: 150px;">
                            <div class="d-flex justify-content-between small mb-1">
                                <span>@s.CompletedModules / @s.TotalModules</span>
                            </div>
                            @{
                                double modProgress = s.TotalModules == 0 ? 0 : ((double)s.CompletedModules / s.TotalModules) * 100;
                            }
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-primary" role="progressbar" style="width: @modProgress%"></div>
                            </div>
                        </td>

                        <td>
                            @if (s.Status == "Active")
                            {
                                <span class="badge bg-success">Active</span>
                            }

                            else if (s.Status == "At Risk")
                            {
                                <span class="badge bg-danger">At Risk</span>
                            }

                            else
                            {
                                <span class="badge bg-secondary">Inactive</span>
                            }
                        </td>

                        <td style="width: 120px;">
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                    @{
                                        string barColor = s.ConsistencyScore >= 75 ? "bg-primary" : (s.ConsistencyScore >= 40 ? "bg-warning" : "bg-danger");
                                    }
                                    <div class="progress-bar @barColor" role="progressbar" style="width: @s.ConsistencyScore%"></div>
                                </div>
                                <small class="fw-bold">@s.ConsistencyScore%</small>
                            </div>
                        </td>

                        <td class="text-end pe-4">

                            <a asp-action="Details"
                               asp-route-id="@s.StudentId"
                               class="btn btn-sm btn-light text-muted mb-1">
                                <i class="fas fa-ellipsis-v"></i>
                            </a>

                            <form asp-action="ResetUserPassword" method="post">
                                <input type="hidden" name="userId" value="@s.UserId" />
                                <button class="btn btn-sm btn-outline-warning">
                                    <i class="fas fa-key"></i>
                                </button>
                            </form>

                        </td>

                    </tr>
                }
            </tbody>
        </table>
    </div>

            @await Html.PartialAsync("_Pagination")
        
</div>